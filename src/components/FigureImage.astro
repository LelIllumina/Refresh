---
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";
import type { HTMLAttributes } from "astro/types";

type AstroImageProps = {
  src: string | URL;
  alt: string;
  width?: number;
  height?: number;
  format?: "avif" | "jpeg" | "png" | "webp";
  quality?: number;
  fit?: "contain" | "cover" | "fill" | "inside" | "outside";
  position?: string;
  background?: string;
  loading?: "lazy" | "eager";
  decoding?: "async" | "sync" | "auto";
  sizes?: string;
  referrerpolicy?: HTMLImageElement["referrerPolicy"];
  style?: string;
  class?: string;
} & HTMLAttributes<"img">;

type Props = AstroImageProps & {
  href?: string;
  noCaption?: boolean;
};

const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/images/**/*.{jpeg,jpg,png,gif,svg,avif,webp}"
);

const { href, src, alt, noCaption = false, ...rest } = Astro.props;

const isPublic = typeof src === "string" && !(src in images);

function generateAlt(src: string | undefined) {
  if (!src) return "";
  const filename = src.split("/").pop()?.split(".")[0];
  return filename?.replace(/[-_]/g, " ") ?? "";
}

const resolvedAlt = alt ?? generateAlt(typeof src === "string" ? src : "");
const imageSrc = !isPublic && typeof src === "string" ? images[src] : null;
---

<figure>
  {
    href ? (
      <a href={href}>
        {isPublic ? (
          <img src={src as string} alt={resolvedAlt} {...rest} />
        ) : (
          <Image src={imageSrc!()} alt={resolvedAlt} {...rest} />
        )}
      </a>
    ) : isPublic ? (
      <img src={src as string} alt={resolvedAlt} {...rest} />
    ) : (
      <Image src={imageSrc!()} alt={resolvedAlt} {...rest} />
    )
  }

  {!noCaption && resolvedAlt && <figcaption>{resolvedAlt}</figcaption>}
</figure>

<style>
  figure {
    margin: 0;
  }
</style>
